name: Build and deploy Frontend Next.js SSR to Azure Web App

on:
  push:
    branches:
      - master

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Installer Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3Ô∏è‚É£ Installer les d√©pendances et build
      - name: Install dependencies + Build
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # 4Ô∏è‚É£ Pr√©parer le package pour Azure
      - name: Prepare deployment package
        working-directory: ./frontend
        run: |
          # Cr√©er le dossier de d√©ploiement
          rm -rf deploy
          mkdir -p deploy
          
          # Copier les fichiers essentiels
          cp package.json package-lock.json deploy/
          cp -r .next deploy/.next
          cp -r public deploy/public
          cp -r app deploy/app
          [ -d lib ] && cp -r lib deploy/lib
          
          # Copier les fichiers de configuration
          [ -f next.config.ts ] && cp next.config.ts deploy/
          [ -f next.config.js ] && cp next.config.js deploy/
          [ -f tsconfig.json ] && cp tsconfig.json deploy/
          [ -f postcss.config.mjs ] && cp postcss.config.mjs deploy/
          [ -f eslint.config.mjs ] && cp eslint.config.mjs deploy/
          
          # Copier les fichiers n√©cessaires pour Azure
          [ -f server.js ] && cp server.js deploy/
          [ -f web.config ] && cp web.config deploy/
          [ -f .deployment ] && cp .deployment deploy/
          [ -f startup.sh ] && cp startup.sh deploy/ && chmod +x deploy/startup.sh
          
          # V√©rifier que le build .next existe
          if [ ! -d ".next" ]; then
            echo "‚ùå Erreur: Le dossier .next n'existe pas. Le build a peut-√™tre √©chou√©."
            exit 1
          fi
          
          # V√©rifier que server.js existe
          if [ ! -f "server.js" ]; then
            echo "‚ùå Erreur: server.js n'existe pas."
            exit 1
          fi
          
          # V√©rifier que package.json existe et contient le bon script start
          if [ -f "package.json" ]; then
            echo "üìÑ Contenu de package.json (scripts):"
            grep -A 5 '"scripts"' package.json
          fi
          
          # Lister le contenu pour v√©rification
          echo "üì¶ Contenu du package de d√©ploiement:"
          ls -la deploy/
          echo "üìÅ V√©rification du dossier .next:"
          if [ -d "deploy/.next" ]; then
            echo "‚úÖ .next existe dans deploy/"
            ls -la deploy/.next/ | head -10
          else
            echo "‚ùå .next n'existe PAS dans deploy/"
          fi
          
          # V√©rifier que server.js est bien copi√©
          if [ -f "deploy/server.js" ]; then
            echo "‚úÖ server.js copi√© dans deploy/"
          else
            echo "‚ùå server.js n'existe PAS dans deploy/"
          fi
          
          # V√©rifier package.json dans deploy
          if [ -f "deploy/package.json" ]; then
            echo "‚úÖ package.json copi√© dans deploy/"
            echo "üìÑ Script start dans deploy/package.json:"
            grep '"start"' deploy/package.json
          else
            echo "‚ùå package.json n'existe PAS dans deploy/"
          fi
          
          # Cr√©er le zip (sans node_modules - Azure les installera)
          cd deploy
          zip -r ../deploy.zip . -q
          cd ..
          
          # Afficher la taille du package
          ls -lh deploy.zip
          echo "‚úÖ Package cr√©√© avec succ√®s"

      # 5Ô∏è‚É£ Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-app
          path: ./frontend/deploy.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      # 1Ô∏è‚É£ Download artifact
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: frontend-app
          path: ./deploy-package

      # 2Ô∏è‚É£ D√©compresser le package
      - name: Extract deployment package
        run: |
          cd ./deploy-package
          unzip -q deploy.zip -d extracted
          ls -la extracted/

      # 3Ô∏è‚É£ Azure login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_FRONT_CLIENTID }}",
              "clientSecret": "${{ secrets.AZURE_FRONT_CLIENTSECRET }}",
              "subscriptionId": "${{ secrets.AZURE_FRONT_SUBSCRIPTION }}",
              "tenantId": "${{ secrets.AZURE_FRONT_TENANTID }}"
            }

      # 4Ô∏è‚É£ Deploy to Azure
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_FRONT_APP_NAME || 'inventory-pro-01' }}
          package: ./deploy-package/extracted
          startup-command: 'node server.js'
          configuration-file: ''
