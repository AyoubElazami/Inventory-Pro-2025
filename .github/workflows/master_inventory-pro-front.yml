name: Build and deploy Frontend Next.js SSR to Azure Web App

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Installer Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3Ô∏è‚É£ Installer les d√©pendances et build
      - name: Install dependencies + Build
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # 4Ô∏è‚É£ Pr√©parer le package pour Azure
      - name: Prepare deployment package
        working-directory: ./frontend
        run: |
          # Cr√©er le dossier de d√©ploiement
          rm -rf deploy
          mkdir -p deploy
          
          # Copier les fichiers essentiels
          cp package.json package-lock.json deploy/
          cp -r .next deploy/.next
          cp -r public deploy/public
          cp -r app deploy/app
          [ -d lib ] && cp -r lib deploy/lib
          
          # Copier les fichiers de configuration
          [ -f next.config.ts ] && cp next.config.ts deploy/
          [ -f next.config.js ] && cp next.config.js deploy/
          [ -f tsconfig.json ] && cp tsconfig.json deploy/
          [ -f postcss.config.mjs ] && cp postcss.config.mjs deploy/
          [ -f eslint.config.mjs ] && cp eslint.config.mjs deploy/
          
          # Copier les fichiers n√©cessaires pour Azure
          [ -f server.js ] && cp server.js deploy/
          [ -f web.config ] && cp web.config deploy/
          [ -f .deployment ] && cp .deployment deploy/
          [ -f startup.sh ] && cp startup.sh deploy/ && chmod +x deploy/startup.sh
          
          # V√©rifier que le build .next existe
          if [ ! -d ".next" ]; then
            echo "‚ùå Erreur: Le dossier .next n'existe pas. Le build a peut-√™tre √©chou√©."
            exit 1
          fi
          
          # V√©rifier que server.js existe
          if [ ! -f "server.js" ]; then
            echo "‚ùå Erreur: server.js n'existe pas."
            exit 1
          fi
          
          # V√©rifier que package.json existe et contient le bon script start
          if [ -f "package.json" ]; then
            echo "üìÑ Contenu de package.json (scripts):"
            grep -A 5 '"scripts"' package.json
          fi
          
          # Lister le contenu pour v√©rification
          echo "üì¶ Contenu du package de d√©ploiement:"
          ls -la deploy/
          echo "üìÅ V√©rification du dossier .next:"
          if [ -d "deploy/.next" ]; then
            echo "‚úÖ .next existe dans deploy/"
            ls -la deploy/.next/ | head -10
          else
            echo "‚ùå .next n'existe PAS dans deploy/"
          fi
          
          # V√©rifier que server.js est bien copi√©
          if [ -f "deploy/server.js" ]; then
            echo "‚úÖ server.js copi√© dans deploy/"
          else
            echo "‚ùå server.js n'existe PAS dans deploy/"
          fi
          
          # V√©rifier package.json dans deploy
          if [ -f "deploy/package.json" ]; then
            echo "‚úÖ package.json copi√© dans deploy/"
            echo "üìÑ Script start dans deploy/package.json:"
            grep '"start"' deploy/package.json
          else
            echo "‚ùå package.json n'existe PAS dans deploy/"
          fi
          
          # Cr√©er le zip (sans node_modules - Azure les installera)
          cd deploy
          zip -r ../deploy.zip . -q
          cd ..
          
          # Afficher la taille du package
          ls -lh deploy.zip
          echo "‚úÖ Package cr√©√© avec succ√®s"

      # 5Ô∏è‚É£ Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-app
          path: ./frontend/deploy.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      # 1Ô∏è‚É£ Download artifact
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: frontend-app
          path: ./deploy-package

      # 2Ô∏è‚É£ D√©compresser le package
      - name: Extract deployment package
        run: |
          cd ./deploy-package
          unzip -q deploy.zip -d extracted
          ls -la extracted/

      # 3Ô∏è‚É£ Azure login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_FRONT_CLIENTID }}",
              "clientSecret": "${{ secrets.AZURE_FRONT_CLIENTSECRET }}",
              "subscriptionId": "${{ secrets.AZURE_FRONT_SUBSCRIPTION }}",
              "tenantId": "${{ secrets.AZURE_FRONT_TENANTID }}"
            }

      # 3.5Ô∏è‚É£ V√©rifier et d√©marrer l'App Service
      - name: Verify and start App Service
        run: |
          APP_NAME="${{ secrets.AZURE_FRONT_APP_NAME || 'inventory-pro-01' }}"
          RESOURCE_GROUP="${{ secrets.AZURE_FRONT_RESOURCE_GROUP || 'IInventory-Pro' }}"
          
          echo "V√©rification de l'App Service: $APP_NAME dans le groupe $RESOURCE_GROUP"
          
          # V√©rifier que l'App Service existe
          APP_EXISTS=$(az webapp show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$APP_NAME" \
            --query "name" \
            -o tsv 2>/dev/null || echo "")
          
          if [ -z "$APP_EXISTS" ]; then
            echo "‚ùå Erreur: L'App Service '$APP_NAME' n'existe pas dans le groupe de ressources '$RESOURCE_GROUP'"
            exit 1
          fi
          
          echo "‚úÖ App Service trouv√©: $APP_EXISTS"
          
          # V√©rifier et d√©marrer l'App Service si n√©cessaire
          APP_STATE=$(az webapp show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$APP_NAME" \
            --query "state" \
            -o tsv)
          
          echo "√âtat actuel de l'App Service: $APP_STATE"
          
          if [ "$APP_STATE" != "Running" ]; then
            echo "‚ö†Ô∏è  L'App Service n'est pas en cours d'ex√©cution. D√©marrage..."
            az webapp start \
              --resource-group "$RESOURCE_GROUP" \
              --name "$APP_NAME"
            
            # Attendre que l'App Service soit d√©marr√©
            echo "‚è≥ Attente du d√©marrage de l'App Service..."
            sleep 10
            
            # V√©rifier √† nouveau
            APP_STATE=$(az webapp show \
              --resource-group "$RESOURCE_GROUP" \
              --name "$APP_NAME" \
              --query "state" \
              -o tsv)
            
            if [ "$APP_STATE" = "Running" ]; then
              echo "‚úÖ App Service d√©marr√© avec succ√®s"
            else
              echo "‚ùå Erreur: Impossible de d√©marrer l'App Service. √âtat: $APP_STATE"
              exit 1
            fi
          else
            echo "‚úÖ App Service est d√©j√† en cours d'ex√©cution"
          fi

      # 4Ô∏è‚É£ Cr√©er le ZIP final pour le d√©ploiement
      - name: Create final deployment zip
        run: |
          cd ./deploy-package/extracted
          zip -r ../../frontend-deploy.zip . -q
          cd ../..
          ls -lh frontend-deploy.zip
          echo "‚úÖ Package ZIP final cr√©√©"

      # 5Ô∏è‚É£ Deploy to Azure
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_FRONT_APP_NAME || 'inventory-pro-01' }}
          package: ./frontend-deploy.zip
          type: zip
          
      # 6Ô∏è‚É£ Configurer la commande de d√©marrage via Azure CLI
      - name: Configure startup command via Azure CLI
        run: |
          APP_NAME="${{ secrets.AZURE_FRONT_APP_NAME || 'inventory-pro-01' }}"
          RESOURCE_GROUP="${{ secrets.AZURE_FRONT_RESOURCE_GROUP || 'IInventory-Pro' }}"
          
          echo "Configuration de la commande de d√©marrage pour $APP_NAME"
          az webapp config set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$APP_NAME" \
            --startup-file "node server.js" \
            --output none
          
          echo "‚úÖ Commande de d√©marrage configur√©e"
          
          # Red√©marrer l'application pour appliquer les changements
          echo "üîÑ Red√©marrage de l'application..."
          az webapp restart \
            --resource-group "$RESOURCE_GROUP" \
            --name "$APP_NAME" \
            --output none
          
          echo "‚úÖ Application red√©marr√©e"
