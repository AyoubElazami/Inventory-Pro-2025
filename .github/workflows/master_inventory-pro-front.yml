name: Build and deploy Frontend Next.js SSR to Azure Web App

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Installer Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3️⃣ Installer les dépendances et build
      - name: Install dependencies + Build
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # 4️⃣ Préparer le package pour Azure
      - name: Prepare deployment package
        working-directory: ./frontend
        run: |
          # Créer le dossier de déploiement
          rm -rf deploy
          mkdir -p deploy
          
          # Copier les fichiers essentiels
          cp package.json package-lock.json deploy/
          cp -r .next deploy/.next
          cp -r public deploy/public
          cp -r app deploy/app
          [ -d lib ] && cp -r lib deploy/lib
          
          # Copier les fichiers de configuration
          [ -f next.config.ts ] && cp next.config.ts deploy/
          [ -f next.config.js ] && cp next.config.js deploy/
          [ -f tsconfig.json ] && cp tsconfig.json deploy/
          [ -f postcss.config.mjs ] && cp postcss.config.mjs deploy/
          [ -f eslint.config.mjs ] && cp eslint.config.mjs deploy/
          
          # Copier les fichiers nécessaires pour Azure
          [ -f server.js ] && cp server.js deploy/
          [ -f web.config ] && cp web.config deploy/
          [ -f .deployment ] && cp .deployment deploy/
          
          # Vérifier que le build .next existe
          if [ ! -d ".next" ]; then
            echo "❌ Erreur: Le dossier .next n'existe pas. Le build a peut-être échoué."
            exit 1
          fi
          
          # Créer le zip (sans node_modules - Azure les installera)
          cd deploy
          zip -r ../deploy.zip . -q
          cd ..
          
          # Afficher la taille du package
          ls -lh deploy.zip
          echo "✅ Package créé avec succès"

      # 6️⃣ Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-app
          path: ./frontend/deploy.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      # 1️⃣ Download artifact
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: frontend-app
          path: ./deploy-package

      # 2️⃣ Décompresser le package
      - name: Extract deployment package
        run: |
          cd ./deploy-package
          unzip -q deploy.zip -d extracted
          ls -la extracted/

      # 3️⃣ Azure login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_FRONT_CLIENTID }}",
              "clientSecret": "${{ secrets.AZURE_FRONT_CLIENTSECRET }}",
              "subscriptionId": "${{ secrets.AZURE_FRONT_SUBSCRIPTION }}",
              "tenantId": "${{ secrets.AZURE_FRONT_TENANTID }}"
            }

      # 4️⃣ Deploy to Azure
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: '${{ secrets.AZURE_FRONT_APP_NAME || "inventory-pro-01" }}'
          package: ./deploy-package/extracted
          startup-command: 'npm start'
